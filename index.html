<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>商品一覧 | あなたのショップ名</title>
  <meta name="description" content="4商品をクリック→サイズ→数量→Stripeで購入（カート無し）。" />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="商品一覧 | あなたのショップ名" />
  <meta property="og:description" content="4商品をクリック→サイズ→数量→Stripeで購入（カート無し）。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://example.com/" />
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=OG" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0c10; --panel:#111218; --muted:#1a1b23; --line:#232432;
      --text:#e6e7ee; --sub:#a4a7b7; --brand:#7c5cff; --accent:#3ddc97; --warn:#ffb86b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:inherit}
    img{max-width:100%;display:block}
    .container{max-width:1200px;margin:auto;padding:24px}
    header{border-bottom:1px solid var(--line);background:rgba(255,255,255,0.02);backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:40}
    .topbar{display:flex;align-items:center;gap:16px;padding:12px 24px}
    .brand{font-weight:700;letter-spacing:.2px}
    .crumbs{font-size:12px;color:var(--sub)}
    .crumbs a{color:var(--sub);text-decoration:none}

    .h1{font-size:28px;font-weight:700;margin:0 0 8px}
    .sub{color:var(--sub)}

    .grid{display:grid;gap:16px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:720px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .panel{padding:20px 20px}

    .product-card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:var(--panel);cursor:pointer}
    .product-card .meta{padding:10px 12px}
    .product-card:hover{outline:2px solid var(--brand)}

    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);cursor:pointer;font-weight:600;}
    .btn.primary{background:linear-gradient(180deg,var(--brand),#5d3bff);color:#fff}
    .btn.secondary{background:var(--muted);color:var(--text)}
    .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:10px 14px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:var(--muted);color:var(--text)}
    .chip[aria-checked="true"],.chip:hover{outline:2px solid var(--brand)}
    .qty{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;margin-top:8px}
    .qty input{width:64px;text-align:center;background:transparent;color:var(--text);border:none}
    .qty button{width:36px;background:var(--muted);color:var(--text);border:none;cursor:pointer}
    .cta{display:flex;gap:12px;margin-top:14px}
    .notice{font-size:12px;color:var(--sub);margin-top:8px}

    footer{border-top:1px solid var(--line);padding:24px;color:var(--sub);margin-top:40px}

    /* hidden を強制的に非表示（ブラウザ差異・テーマ衝突対策） */
    [hidden]{ display:none !important; }
  </style>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">🛍️ あなたのショップ名</div>
    </div>
    <div class="container crumbs" aria-label="breadcrumb">
      <a href="./">ホーム</a> / <span aria-current="page">商品一覧</span>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" style="margin:12px 0 16px">商品一覧</h1>
    <p class="sub" style="margin:0 0 12px">商品をクリック → サイズ選択 → 数量 → Stripe決済（カート無し）。</p>

    <!-- ★4商品のみ。必ず data-product を付ける -->
    <section class="grid" id="product-list">
      <article class="product-card" data-product="komeA">
        <img src="https://via.placeholder.com/600x600.png?text=Kome+A" alt="米A">
        <div class="meta"><div>米A（コシヒカリ）</div><div class="sub">¥2,480〜</div></div>
      </article>
      <article class="product-card" data-product="komeB">
        <img src="https://via.placeholder.com/600x600.png?text=Kome+B" alt="米B">
        <div class="meta"><div>米B（あきたこまち）</div><div class="sub">¥2,280〜</div></div>
      </article>
      <article class="product-card" data-product="imoA">
        <img src="https://via.placeholder.com/600x600.png?text=Imo+A" alt="芋A">
        <div class="meta"><div>芋A（さつまいも）</div><div class="sub">¥580〜</div></div>
      </article>
      <article class="product-card" data-product="imoB">
        <img src="https://via.placeholder.com/600x600.png?text=Imo+B" alt="芋B">
        <div class="meta"><div>芋B（じゃがいも）</div><div class="sub">¥480〜</div></div>
      </article>
    </section>
  </main>

  <!-- モーダル（初期は必ず hidden） -->
  <div id="buy-modal" hidden
       style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="card panel" style="width:min(640px,92vw);">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 id="modal-title" class="h1" style="font-size:20px;margin:0">購入</h2>
        <button id="close-modal" class="btn secondary" style="flex:0 0 auto;padding:6px 10px">閉じる</button>
      </div>

      <!-- Step 1: サイズ -->
      <div id="step-size" style="margin-top:10px">
        <label class="sub">サイズを選択</label>
        <div id="size-choices" class="choices" role="listbox" aria-label="サイズ"></div>
        <button id="next-to-qty" class="btn primary" style="margin-top:12px">次へ</button>
      </div>

      <!-- Step 2: 数量 -->
      <div id="step-qty" hidden>
        <label class="sub">数量を選択</label>
        <div class="qty" aria-label="数量">
          <button type="button" data-action="dec">−</button>
          <input type="number" id="modal-qty" value="1" min="1" inputmode="numeric" aria-label="数量">
          <button type="button" data-action="inc">＋</button>
        </div>
        <div class="cta">
          <button id="checkout" class="btn primary">Stripeで購入</button>
          <button id="back-to-size" class="btn secondary">戻る</button>
        </div>
        <div class="notice">テストカード: 4242 4242 4242 4242 / 任意の期限・CVC</div>
      </div>
    </div>
  </div>

  <footer class="container">
    <div>© <span id="year"></span> あなたのショップ名</div>
  </footer>

  <script>
    // ===== 初期セットアップ =====
    document.getElementById('year').textContent = new Date().getFullYear();

    // Stripe 公開可能キー（後で pk_test_... に差し替え）
    const stripe = Stripe('pk_test_CHANGE_ME');

    // 商品 → サイズ → Price ID（後で price_xxx に差し替え）
    const PRICE_MAP = {
      komeA: { title: '米A（コシヒカリ）',
        sizes: [
          { label: '5kg',  priceId: 'price_TEST_komeA_5kg' },
          { label: '10kg', priceId: 'price_TEST_komeA_10kg' }
        ] },
      komeB: { title: '米B（あきたこまち）',
        sizes: [
          { label: '5kg',  priceId: 'price_TEST_komeB_5kg' },
          { label: '10kg', priceId: 'price_TEST_komeB_10kg' }
        ] },
      imoA:  { title: '芋A（さつまいも）',
        sizes: [
          { label: '1kg', priceId: 'price_TEST_imoA_1kg' },
          { label: '3kg', priceId: 'price_TEST_imoA_3kg' }
        ] },
      imoB:  { title: '芋B（じゃがいも）',
        sizes: [
          { label: '1kg', priceId: 'price_TEST_imoB_1kg' },
          { label: '3kg', priceId: 'price_TEST_imoB_3kg' }
        ] }
    };

    // 要素参照
    const modal    = document.getElementById('buy-modal');
    const titleEl  = document.getElementById('modal-title');
    const sizeBox  = document.getElementById('size-choices');
    const stepSize = document.getElementById('step-size');
    const stepQty  = document.getElementById('step-qty');
    const qtyInput = document.getElementById('modal-qty');

    // 念のため初期は必ず閉じる（hidden 強制）
    modal.setAttribute('hidden','');

    let selected = { productKey:null, priceId:null, sizeLabel:null, qty:1 };

    // ===== 商品クリック → モーダル表示 =====
    document.querySelectorAll('.product-card[data-product]').forEach(card=>{
      card.addEventListener('click', ()=>{
        const key  = card.dataset.product;
        const meta = PRICE_MAP[key];

        if(!meta || !Array.isArray(meta.sizes) || meta.sizes.length===0){
          alert('商品またはサイズ定義が見つかりません: ' + key);
          return;
        }

        selected = { productKey:key, priceId:null, sizeLabel:null, qty:1 };
        titleEl.textContent = `購入：${meta.title}`;

        // サイズボタン描画（先頭を既定選択）
        sizeBox.innerHTML = meta.sizes.map((s,i)=>
          `<button class="chip" type="button" role="option"
                   aria-checked="${i===0}" data-price="${s.priceId}" data-label="${s.label}">
             ${s.label}
           </button>`
        ).join('');

        if(sizeBox.children.length === 0){
          alert('サイズの描画に失敗しました（id="size-choices" を確認）');
          return;
        }

        // ステップ表示と数量初期化
        stepSize.hidden = false;
        stepQty.hidden  = true;
        qtyInput.value  = 1;

        // ここで初めて開く
        modal.removeAttribute('hidden');
      });
    });

    // ===== サイズ選択のトグル =====
    sizeBox.addEventListener('click',(e)=>{
      const chip = e.target.closest('.chip'); 
      if(!chip) return;
      sizeBox.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-checked','false'));
      chip.setAttribute('aria-checked','true');
    });

    // 次へ（サイズ→数量）
    document.getElementById('next-to-qty').onclick = ()=>{
      const chosen = sizeBox.querySelector('.chip[aria-checked="true"]');
      if(!chosen){ alert('サイズを選択してください'); return; }
      selected.priceId   = chosen.dataset.price;
      selected.sizeLabel = chosen.dataset.label;
      stepSize.hidden = true;
      stepQty.hidden  = false;
    };

    // 戻る（数量→サイズ）
    document.getElementById('back-to-size').onclick = ()=>{
      stepQty.hidden = true;
      stepSize.hidden = false;
    };

    // 数量ステッパー
    stepQty.querySelector('[data-action="inc"]').onclick = ()=> qtyInput.value = (+qtyInput.value||1)+1;
    stepQty.querySelector('[data-action="dec"]').onclick = ()=> qtyInput.value = Math.max(1,(+qtyInput.value||1)-1);

    // ===== モーダルの閉じ方を強化（ボタン・背景・ESC） =====
    document.getElementById('close-modal').onclick = ()=> modal.setAttribute('hidden','');
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.setAttribute('hidden',''); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') modal.setAttribute('hidden',''); });

    // ===== Stripe Checkout へ（サーバーレス関数に POST） =====
    document.getElementById('checkout').onclick = async ()=>{
      if(!selected.priceId){ alert('サイズを選択してください'); return; }
      const qty = Math.max(1, +qtyInput.value||1);

      const ENDPOINT = 'https://YOUR_SERVER/create-checkout-session'; // ←Vercel/Netlify/CloudflareのURLに差し替え
      try{
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            priceId: selected.priceId,
            quantity: qty,
            metadata: { product: selected.productKey, size: selected.sizeLabel }
          })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'エラー');
        await stripe.redirectToCheckout({ sessionId: data.id });
      }catch(err){
        alert(err.message || '決済開始に失敗しました（エンドポイント未設定の可能性）');
      }
    };
  </script>
</body>
</html>
