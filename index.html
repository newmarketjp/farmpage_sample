<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>商品一覧 | Newmarket happy grain</title>
  <meta name="description" content="商品をクリック → サイズ選択 → Stripe Buy Buttonで決済。" />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="商品一覧 | Newmarket happy grain" />
  <meta property="og:description" content="商品をクリック → サイズ選択 → Stripe Buy Buttonで決済。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://example.com/" />
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=OG" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stripe Buy Button（1回だけ読み込み） -->
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>

  <style>
    :root{
      --bg:#f6faf7; --panel:#ffffff; --muted:#f3f4f6; --line:#e5e7eb;
      --text:#111827; --sub:#6b7280; --brand:#0ea47a; --accent:#10b981; --warn:#f59e0b;
      --pane-width: 440px; /* 左カード幅と右パネル幅を揃える */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    a{color:inherit}
    img{max-width:100%;display:block}
    .container{max-width:1200px;margin:auto;padding:24px}
    header{border-bottom:1px solid var(--line);background:rgba(255,255,255,0.7);backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:40}
    .topbar{display:flex;align-items:center;gap:16px;padding:12px 24px}
    .brand{font-weight:700;letter-spacing:.2px}
    .crumbs{font-size:12px;color:var(--sub)}
    .crumbs a{color:var(--sub);text-decoration:none}

    .h1{font-size:28px;font-weight:700;margin:0 0 8px}
    .sub{color:var(--sub)}

    /* レイアウト：左(カード) + 右(パネル) */
    .grid{display:grid;gap:16px;grid-template-columns:1fr;align-items:start;}
    @media (min-width:960px){ .grid{ grid-template-columns: var(--pane-width) minmax(0,1fr); } }

    .product-card{
      border:1px solid var(--line);border-radius:14px;overflow:hidden;background:var(--panel);cursor:pointer;
      width:100%;max-width:var(--pane-width);justify-self:start;grid-column:1 / -1;
    }
    @media (min-width:960px){
      .product-card.open{ grid-column:1 / 2; align-self:stretch; } /* 右パネルとバランスを揃える */
    }
    .product-card .meta{padding:10px 12px}
    .product-card:hover{outline:2px solid var(--brand)}

    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);cursor:pointer;font-weight:600;}
    .btn.secondary{background:var(--muted);color:var(--text)}
    .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:10px 14px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#f7f7f9;color:var(--text)}
    .chip[aria-checked="true"],.chip:hover{outline:2px solid var(--brand)}
    .notice{font-size:12px;color:var(--sub);margin-top:8px}

    footer{border-top:1px solid var(--line);padding:24px;color:var(--sub);margin-top:40px}

    /* 右側の購入パネル */
    .picker{
      border:1px solid var(--line);border-radius:14px;background:var(--panel);
      padding:16px;margin:12px 0;width:100%;max-width:var(--pane-width);justify-self:start;
      grid-column:1 / -1;align-self:start;
    }
    @media (min-width:960px){ .picker{ grid-column:2 / 3; } }
    .picker h2{margin:0}
    .buy-slot{margin-top:14px}
  </style>
</head>
<body>
  <header>
    <div class="topbar"><div class="brand">Newmarket happy grain</div></div>
    <div class="container crumbs" aria-label="breadcrumb">
      <a href="./">ホーム</a> / <span aria-current="page">商品一覧</span>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" style="margin:12px 0 16px">商品一覧</h1>
    <p class="sub" style="margin:0 0 12px">商品をクリック → サイズ選択 → 右側に Stripe（Buy Button）が表示されます。</p>

    <section class="grid" id="product-list">
      <article class="product-card" data-product="imoA">
        <img src="https://via.placeholder.com/600x600.png?text=%E3%82%B7%E3%83%AB%E3%82%AF%E3%82%B9%E3%82%A4%E3%83%BC%E3%83%88" alt="シルクスイート">
        <div class="meta"><div>シルクスイート</div><div class="sub">¥580〜</div></div>
      </article>
      <article class="product-card" data-product="imoB">
        <img src="https://via.placeholder.com/600x600.png?text=%E3%81%B9%E3%81%AB%E3%81%AF%E3%82%8B%E3%81%8B" alt="べにはるか">
        <div class="meta"><div>べにはるか</div><div class="sub">¥480〜</div></div>
      </article>
      <article class="product-card" data-product="komeA">
        <img src="https://via.placeholder.com/600x600.png?text=%E3%82%B3%E3%82%B7%E3%83%92%E3%82%AB%E3%83%AA" alt="コシヒカリ">
        <div class="meta"><div>コシヒカリ</div><div class="sub">¥2,480〜</div></div>
      </article>
      <article class="product-card" data-product="komeB">
        <img src="https://via.placeholder.com/600x600.png?text=%E3%81%B5%E3%81%95%E3%81%8A%E3%81%A8%E3%82%81" alt="ふさおとめ">
        <div class="meta"><div>ふさおとめ</div><div class="sub">¥2,280〜</div></div>
      </article>
    </section>
  </main>

  <footer class="container">
    <div>© <span id="year"></span> Newmarket happy grain</div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // サイズ定義（表示用ラベル）
    const PRICE_MAP = {
      imoA: { title:'シルクスイート', sizes:[{label:'1kg'},{label:'3kg'}] },
      imoB: { title:'べにはるか',     sizes:[{label:'1kg'},{label:'3kg'}] },
      komeA:{ title:'コシヒカリ',     sizes:[{label:'5kg'},{label:'10kg'}] },
      komeB:{ title:'ふさおとめ',     sizes:[{label:'5kg'},{label:'10kg'}] }
    };

    // Buy Button ID（サイズごとに割当）
    // ※いただいた4つを反映。未設定サイズはコメントの行に追記してください。
    const BUY_MAP = {
      'imoA:1kg': 'buy_btn_1RxItEEOlIsLAXPbrlPWgEsu', // シルクスイート 1kg
      // 'imoA:3kg': 'buy_btn_xxx_imoA_3kg',

      'imoB:1kg': 'buy_btn_1RxLHlEOlIsLAXPbwYXSedij', // べにはるか 1kg
      // 'imoB:3kg': 'buy_btn_xxx_imoB_3kg',

      'komeA:5kg': 'buy_btn_1RxLIIEOlIsLAXPbpkLNt0Uw', // コシヒカリ 5kg
      // 'komeA:10kg': 'buy_btn_xxx_komeA_10kg',

      'komeB:5kg': 'buy_btn_1RxLH6EOlIsLAXPbJLQvuP1O', // ふさおとめ 5kg
      // 'komeB:10kg': 'buy_btn_xxx_komeB_10kg',
    };

    // 公開鍵（Buy Button属性で自動使用されます。Stripeが内部で検証）
    const PUBLISHABLE_KEY = 'pk_test_51MpmrqEOlIsLAXPbhG3nnraXNQYGpEeSoEfO8YPmNNeqjrQFMYVfGIMCo1alSywBAIxQaG4t9mI0KVHI7s0K5z2J00R5ZpaV8y';

    function renderPicker(key){
      const meta = PRICE_MAP[key];
      const sizeChips = meta.sizes.map((s,i)=>`
        <button class="chip size-chip" type="button" role="option"
                aria-checked="${i===0}" data-label="${s.label}">
          ${s.label}
        </button>`).join('');

      return `
        <div class="picker" data-open-for="${key}">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <h2 class="h1" style="font-size:20px;margin:0">購入：${meta.title}</h2>
            <button class="btn secondary close-picker">閉じる</button>
          </div>

          <div style="margin-top:8px">
            <label class="sub">サイズを選択（右に決済カードを表示）</label>
            <div class="choices size-choices" role="listbox" aria-label="サイズ">${sizeChips}</div>
          </div>

          <div class="buy-slot" aria-live="polite"></div>
        </div>`;
    }

    // 選択サイズに応じて Buy Button を差し替え（遷移はせず、その場に表示）
    function mountBuyButton(picker, productKey, label){
      const mapKey = `${productKey}:${label}`;
      const buyId  = BUY_MAP[mapKey];
      const slot   = picker.querySelector('.buy-slot');
      if(!slot) return;
      slot.innerHTML = '';

      if(buyId){
        const btn = document.createElement('stripe-buy-button');
        btn.setAttribute('buy-button-id', buyId);
        btn.setAttribute('publishable-key', PUBLISHABLE_KEY);
        // btn.setAttribute('locale', 'ja'); // 日本語固定したい場合
        slot.appendChild(btn);
      }else{
        slot.innerHTML = `<div class="notice">このサイズの Buy Button が未設定です。Stripeで作成後、<code>BUY_MAP['${mapKey}']</code> にIDを追記してください。</div>`;
      }
    }

    // クリック → 右パネル表示（同時に他の開きを閉じる）
    document.querySelectorAll('.product-card[data-product]').forEach(card=>{
      card.addEventListener('click', ()=>{
        const key = card.dataset.product;
        const meta = PRICE_MAP[key];
        if(!meta || !meta.sizes?.length){ alert('サイズ定義がありません: ' + key); return; }

        // 既存の開きを閉じる
        document.querySelectorAll('.picker').forEach(p=>p.remove());
        document.querySelectorAll('.product-card.open').forEach(c=>c.classList.remove('open'));

        // 開く
        card.classList.add('open');
        card.insertAdjacentHTML('afterend', renderPicker(key));

        const picker  = card.nextElementSibling;
        const sizeBox = picker.querySelector('.size-choices');
        const closeBtn= picker.querySelector('.close-picker');

        // 初回：1つ目のサイズで表示
        const initialLabel = meta.sizes[0].label;
        mountBuyButton(picker, key, initialLabel);

        // サイズ変更時：その場で差し替え
        sizeBox.addEventListener('click',(e)=>{
          const chip = e.target.closest('.size-chip'); if(!chip) return;
          sizeBox.querySelectorAll('.size-chip').forEach(c=>c.setAttribute('aria-checked','false'));
          chip.setAttribute('aria-checked','true');
          mountBuyButton(picker, key, chip.dataset.label);
        });

        // 閉じる
        closeBtn.onclick = ()=>{ picker.remove(); card.classList.remove('open'); };
      });
    });
  </script>
</body>
</html>
